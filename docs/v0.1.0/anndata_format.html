
<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>AnnData Format · Daf.jl v0.1.0
</title>
<meta name="title" content="AnnData Format · Daf.jl v0.1.0"/>
<meta property="og:title" content="AnnData Format · Daf.jl v0.1.0"/>
<meta property="twitter:title" content="AnnData Format · Daf.jl v0.1.0"/>
<meta name="description" content="Documentation for Daf.jl v0.1.0."/>
<meta property="og:description" content="Documentation for Daf.jl v0.1.0."/>
<meta property="twitter:description" content="Documentation for Daf.jl v0.1.0."/>
<script data-outdated-warner src="assets/warner.js">
</script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/>
<script>documenterBaseURL="."
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="assets/documenter.js">
</script>
<script src="search_index.js">
</script>
<script src="siteinfo.js">
</script>
<script src="../versions.js">
</script>
<link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/>
<link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/>
<script src="assets/themeswap.js">
</script>
</head>
<body>
<div id="documenter">
<nav class="docs-sidebar">
<a class="docs-logo" href="index.html">
<img src="assets/logo.svg" alt="Daf.jl v0.1.0 logo"/>
</a>
<div class="docs-package-name">
<span class="docs-autofit">
<a href="index.html">Daf.jl v0.1.0
</a>
</span>
</div>
<button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)
</button>
<ul class="docs-menu">
<li>
<a class="tocitem" href="index.html">Daf
</a>
</li>
<li>
<a class="tocitem" href="data.html">Data
</a>
</li>
<li>
<a class="tocitem" href="read_only.html">Read-only
</a>
</li>
<li>
<a class="tocitem" href="queries.html">Queries
</a>
</li>
<li>
<a class="tocitem" href="tokens.html">Tokens
</a>
</li>
<li>
<a class="tocitem" href="views.html">Views
</a>
</li>
<li>
<a class="tocitem" href="chains.html">Chains
</a>
</li>
<li>
<a class="tocitem" href="computations.html">Computations
</a>
</li>
<li>
<a class="tocitem" href="copies.html">Copies
</a>
</li>
<li>
<a class="tocitem" href="concat.html">Concat
</a>
</li>
<li>
<a class="tocitem" href="adapters.html">Adapters
</a>
</li>
<li>
<a class="tocitem" href="contracts.html">Contracts
</a>
</li>
<li>
<a class="tocitem" href="formats.html">Formats
</a>
</li>
<li>
<a class="tocitem" href="memory_format.html">Memory Format
</a>
</li>
<li>
<a class="tocitem" href="h5df_format.html">H5DF Format
</a>
</li>
<li>
<a class="tocitem" href="files_format.html">Files Format
</a>
</li>
<li class="is-active">
<a class="tocitem" href="anndata_format.html">AnnData Format
</a>
<ul class="internal">
<li>
<a class="tocitem" href="#Index">
<span>Index
</span>
</a>
</li>
</ul>
</li>
<li>
<a class="tocitem" href="registry.html">Operations registry
</a>
</li>
<li>
<a class="tocitem" href="operations.html">Query operations
</a>
</li>
<li>
<a class="tocitem" href="storage_types.html">Storage types
</a>
</li>
<li>
<a class="tocitem" href="matrix_layouts.html">Matrix layouts
</a>
</li>
<li>
<a class="tocitem" href="messages.html">Messages
</a>
</li>
<li>
<a class="tocitem" href="generic.html">Generic
</a>
</li>
<li>
<a class="tocitem" href="example_data.html">Example data
</a>
</li>
<li>
<a class="tocitem" href="todo.html">TODO
</a>
</li>
</ul>
<div class="docs-version-selector field has-addons">
<div class="control">
<span class="docs-label button is-static is-size-7">Version
</span>
</div>
<div class="docs-selector control is-expanded">
<div class="select is-fullwidth is-size-7">
<select id="documenter-version-selector">
</select>
</div>
</div>
</div>
</nav>
<div class="docs-main">
<header class="docs-navbar">
<a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#">
</a>
<nav class="breadcrumb">
<ul class="is-hidden-mobile">
<li class="is-active">
<a href="anndata_format.html">AnnData Format
</a>
</li>
</ul>
<ul class="is-hidden-tablet">
<li class="is-active">
<a href="anndata_format.html">AnnData Format
</a>
</li>
</ul>
</nav>
<div class="docs-right">
<a class="docs-navbar-link" href="https://github.com/tanaylab/Daf.jl/blob/main{path}?plain=1#L{line}" title="View the repository on GitHub">
<span class="docs-icon fa-brands">
</span>
<span class="docs-label is-hidden-touch">GitHub
</span>
</a>
<a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings">
</a>
<a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings">
</a>
</div>
</header>
<article class="content" id="documenter-page">
<h1 id="AnnData-Format">
<a class="docs-heading-anchor" href="#AnnData-Format">AnnData Format
</a>
<a id="AnnData-Format-1">
</a>
<a class="docs-heading-anchor-permalink" href="#AnnData-Format" title="Permalink">
</a>
</h1>
<article class="docstring">
<header>
<a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring">
</a>
<a class="docstring-binding" id="Daf.AnnDataFormat" href="#Daf.AnnDataFormat">
<code>Daf.AnnDataFormat
</code>
</a> — 
<span class="docstring-category">Module
</span>
</header>
<section>
<div>
<p>Import/export 
<code>Daf
</code> data from/to 
<code>AnnData
</code>.
</p>
<p>Due to the different data models, not all the content of 
<code>AnnData
</code> can be represented as 
<code>Daf
</code>, and vice-versa. However, &quot;most&quot; of the data can be automatically converted from one form to the other. In both directions, conversion is zero-copy; that is, we merely create a different view for the same vectors and matrices. We also use memory-mapping whenever possible for increased performance.
</p>
<div class="admonition is-info">
<header class="admonition-header">Note
</header>
<div class="admonition-body">
<p>We use the 
<code>AnnData
</code> Julia implementation from 
<a href="https://docs.juliahub.com/Muon/QfqCh/0.1.1/">Muon.jl
</a>. The last published released for this package is from 2021, and lacks features added over the years, which we use. Therefore, currently 
<code>Daf
</code> uses the head revision of Muon from 
<a href="https://github.com/scverse/Muon.jl">github
</a>, with all that implies. We&#39;ll change this to a proper registry dependency if/when a new Muon version is released.
</p>
</div>
</div>
<p>The following 
<code>Daf
</code> data can&#39;t be naively stored in 
<code>AnnData
</code>:
</p>
<ul>
<li>
<code>AnnData
</code> is restricted to storing data for only two axes, which 
<code>AnnData
</code> always calls &quot;obs&quot; and &quot;var&quot;. In contrast, 
<code>Daf
</code> can store data for an arbitrary set of meaningfully named axes.
</li>
<li>
<code>Anndata
</code> always contains a matrix property for these two axes called &quot;X&quot;. Mercifully, the rest of the matrices are allowed to have meaningful names. In contrast, 
<code>Daf
</code> allows storing an arbitrary set of meaningfully named matrices.
</li>
<li>
<code>AnnData
</code> can only hold row-major matrices, while Julia defaults to column-major layout.
</li>
</ul>
<p>Therefore, when viewing 
<code>Daf
</code> data as 
<code>AnnData
</code>, we pick two specific axes and rename them to &quot;obs&quot; and &quot;var&quot;, pick a specific matrix property of these axes and rename it to &quot;X&quot;, and 
<a href="matrix_layouts.html#Daf.MatrixLayouts.relayout!">
<code>relayout!
</code>
</a> it if needed so 
<code>AnnData
</code> would be happy. We store the discarded names of the axes and matrix in unstructured annotations called 
<code>obs_is
</code>, 
<code>var_is
</code> and 
<code>X_is
</code>. This allows us to reconstruct the original names when re-viewing the 
<code>AnnData
</code> as 
<code>Daf
</code> data.
</p>
<p>The following 
<code>AnnData
</code> can&#39;t be naively stored in 
<code>Daf
</code>:
</p>
<ul>
<li>Non-scalars (e.g., mappings) inside 
<code>uns
</code> unstructured annotations. The 
<code>Daf
</code> equivalent is storing JSON string blobs, which is awkward to use. TODO: provide better API to deal with such data.
</li>
<li>Data using nullable entries (e.g. a matrix with nullable integer entries). In contrast, 
<code>Daf
</code> supports the convention that zero values are special. This only works in some cases (e.g., it isn&#39;t a good solution for Boolean data). It is possible of course to explicitly store Boolean masks and apply them to the data, but this is inconvenient. TODO: Have 
<code>Daf
</code> natively support nullable/masked arrays.
</li>
<li>Matrix data that only uses one of the axes (that is, 
<code>obsm
</code> and 
<code>varm
</code> data). The problem here is, paradoxically, that 
<code>Daf
</code> supports such data &quot;too well&quot;, by allowing multiple axes to be defined, and storing matrices based on any pair of axes. However, this requires the other axes to be explicitly created, and their information just doesn&#39;t exist in the 
<code>AnnData
</code> data set. TODO: Allow unstructured annotations to store the entries of the other axis.
</li>
</ul>
<p>When viewing 
<code>AnnData
</code> as 
<code>Daf
</code>, we either ignore, warn, or treat as an error any such unsupported data.
</p>
<div class="admonition is-warning">
<header class="admonition-header">DANGER, WILL ROBINSON
</header>
<div class="admonition-body">
<p>Square matrices accessed via 
<code>Daf
</code> APIs will be the (column-major) 
<strong>transpose
</strong> of the original 
<code>AnnData
</code> (row-major) matrix.
</p>
<p>Due to limitations of the 
<code>Daf
</code> data model, square matrices are stored only in column-major layout. In contrast, 
<code>AnnData
</code> square matrices (
<code>obsp
</code>, 
<code>varp
</code>), are stored in row-major layout. We have several bad options to address this:
</p>
<ul>
<li>We can break the 
<code>Daf
</code> invariant that all accessed data is column-major, at least for square matrices. This is bad because the invariant greatly simplifies 
<code>Daf
</code> client code. Forcing clients to check the data layout and calling 
<code>relayout!
</code> would add a lot of error-prone boilerplate to our users.
</li>
<li>We can 
<code>relayout!
</code> the data when copying it between 
<code>AnnData
</code> and 
<code>Daf
</code>. This is bad because, it would force us to duplicate the data. More importantly, there is typically a good reason for the layout of the data. For example, assume a directed graph between cells. A common way to store is is to have a square matrix where each row contains the weights of the edges originating in one cell, connecting it to all other cells. This allows code to efficiently &quot;loop on all cells; loop on all outgoing edges&quot;. If we 
<code>relayout!
</code> the data, then such a loop would become extremely inefficient.
</li>
<li>We can return the transposed matrix from 
<code>Daf
</code>. This is bad because Julia code and Python code processing the &quot;same&quot; data would need to flip the indices (e.g., 
<code>outgoing_weight[from_cell, to_cell]
</code> in Python vs. 
<code>outgoing_weight[to_cell, from_cell]
</code> in Julia).
</li>
</ul>
<p>Having to pick between these bad options, we chose the last one as the lesser evil. The assumption is that Julia code is written separately from the Python code anyway. If the same algorithm is implemented in both systems, it would work (efficiently!), as long as the developer read this warning and flipped the order of the indices, that is.
</p>
<p>We do 
<strong>not
</strong> have this problem with non-square matrices (e.g., the per-cell-per-gene 
<code>UMIs
</code> matrix), since 
<code>Daf
</code> allows for storing and accessing both layouts of the same data in this case. We simply populate 
<code>Daf
</code> with the row-major data from 
<code>AnnData
</code> and if asked for the outher layout, will 
<code>relayout!
</code> it (and store/cache the result).
</p>
</div>
</div>
</div>
</section>
</article>
<article class="docstring">
<header>
<a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring">
</a>
<a class="docstring-binding" id="Daf.AnnDataFormat.anndata_as_daf" href="#Daf.AnnDataFormat.anndata_as_daf">
<code>Daf.AnnDataFormat.anndata_as_daf
</code>
</a> — 
<span class="docstring-category">Function
</span>
</header>
<section>
<div>
<pre>
<code class="language-julia hljs">anndata_as_daf(
    adata::Union{AnnData, AbstractString};
    [name::Maybe{AbstractString} = nothing,
    obs_is::Maybe{AbstractString} = nothing,
    var_is::Maybe{AbstractString} = nothing,
    X_is::Maybe{AbstractString} = nothing,
    unsupported_handler::AbnormalHandler = WarnHandler]
)::MemoryDaf
</code>
</pre>
<p>View 
<code>AnnData
</code> as a 
<code>Daf
</code> data set, specifically using a 
<a href="memory_format.html#Daf.MemoryFormat.MemoryDaf">
<code>MemoryDaf
</code>
</a>. This doesn&#39;t duplicate matrices or vectors, but acts as a view containing references to the same ones. Adding and/or deleting data in the view using the 
<code>Daf
</code> API will not affect the original 
<code>adata
</code>.
</p>
<p>Any unsupported 
<code>AnnData
</code> annotations will be handled using the 
<code>unsupported_handler
</code>. By default, we&#39;ll warn about each and every such unsupported property.
</p>
<p>If 
<code>adata
</code> is a string, then it is the path of an 
<code>h5ad
</code> file which is automatically loaded.
</p>
<p>If not specified, the 
<code>name
</code> will be the value of the &quot;name&quot; 
<code>uns
</code> property, if it exists, otherwise, it will be &quot;anndata&quot;.
</p>
<p>If not specified, 
<code>obs_is
</code> (the name of the &quot;obs&quot; axis) will be the value of the &quot;obs_is&quot; 
<code>uns
</code> property, if it exists, otherwise, it will be &quot;obs&quot;.
</p>
<p>If not specified, 
<code>var_is
</code> (the name of the &quot;var&quot; axis) will be the value of the &quot;var_is&quot; 
<code>uns
</code> property, if it exists, otherwise, it will be &quot;var&quot;.
</p>
<p>If not specified, 
<code>X_is
</code> (the name of the &quot;X&quot; matrix) will be the value of the &quot;X_is&quot; 
<code>uns
</code> property, if it exists, otherwise, it will be &quot;X&quot;.
</p>
</div>
</section>
</article>
<article class="docstring">
<header>
<a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring">
</a>
<a class="docstring-binding" id="Daf.AnnDataFormat.daf_as_anndata" href="#Daf.AnnDataFormat.daf_as_anndata">
<code>Daf.AnnDataFormat.daf_as_anndata
</code>
</a> — 
<span class="docstring-category">Function
</span>
</header>
<section>
<div>
<pre>
<code class="language-julia hljs">daf_as_anndata(
    daf::DafReader;
    [obs_is::Maybe{AbstractString} = nothing,
    var_is::Maybe{AbstractString} = nothing,
    X_is::Maybe{AbstractString} = nothing,
    h5ad::Maybe{AbstractString} = nothing]
)::AnnData
</code>
</pre>
<p>View the 
<code>daf
</code> data set as 
<code>AnnData
</code>. This doesn&#39;t duplicate matrices or vectors, but acts as a view containing references to the same ones. Adding and/or deleting data in the view using the 
<code>AnnData
</code> API will not affect the original 
<code>daf
</code> data set.
</p>
<p>If specified, the result is also written to an 
<code>h5ad
</code> file.
</p>
<p>If not specified, 
<code>obs_is
</code> (the name of the &quot;obs&quot; axis) will be the value of the &quot;obs_is&quot; scalar property, if it exists, otherwise, it will be &quot;obs&quot;.
</p>
<p>If not specified, 
<code>var_is
</code> (the name of the &quot;var&quot; axis) will be the value of the &quot;var_is&quot; scalar property, if it exists, otherwise, it will be &quot;var&quot;.
</p>
<p>If not specified, 
<code>X_is
</code> (the name of the &quot;X&quot; matrix) will be the value of the &quot;X_is&quot; scalar property, if it exists, otherwise, it will be &quot;X&quot;.
</p>
<p>Each of the final 
<code>obs_is
</code>, 
<code>var_is
</code>, 
<code>X_is
</code> values is stored as unstructured annotations, unless the default value (&quot;obs&quot;, &quot;var&quot;, &quot;X&quot;) is used.
</p>
<p>All scalar properties, vector properties of the chosen &quot;obs&quot; and &quot;var&quot; axes, and matrix properties of these axes, are stored in the returned new 
<code>AnnData
</code> object.
</p>
</div>
</section>
</article>
<h2 id="Index">
<a class="docs-heading-anchor" href="#Index">Index
</a>
<a id="Index-1">
</a>
<a class="docs-heading-anchor-permalink" href="#Index" title="Permalink">
</a>
</h2>
<ul>
<li>
<a href="anndata_format.html#Daf.AnnDataFormat">
<code>Daf.AnnDataFormat
</code>
</a>
</li>
<li>
<a href="anndata_format.html#Daf.AnnDataFormat.anndata_as_daf">
<code>Daf.AnnDataFormat.anndata_as_daf
</code>
</a>
</li>
<li>
<a href="anndata_format.html#Daf.AnnDataFormat.daf_as_anndata">
<code>Daf.AnnDataFormat.daf_as_anndata
</code>
</a>
</li>
</ul>
</article>
<nav class="docs-footer">
<a class="docs-footer-prevpage" href="files_format.html">« Files Format
</a>
<a class="docs-footer-nextpage" href="registry.html">Operations registry »
</a>
<div class="flexbox-break">
</div>
<p class="footer-message">Powered by 
<a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl
</a> and the 
<a href="https://julialang.org/">Julia Programming Language
</a>.
</p>
</nav>
</div>
<div class="modal" id="documenter-settings">
<div class="modal-background">
</div>
<div class="modal-card">
<header class="modal-card-head">
<p class="modal-card-title">Settings
</p>
<button class="delete">
</button>
</header>
<section class="modal-card-body">
<p>
<label class="label">Theme
</label>
<div class="select">
<select id="documenter-themepicker">
<option value="auto">Automatic (OS)
</option>
<option value="documenter-light">documenter-light
</option>
<option value="documenter-dark">documenter-dark
</option>
</select>
</div>
</p>
<hr/>
<p>This document was generated with 
<a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl
</a> version 1.3.0. Using Julia version 1.10.2.
</p>
</section>
<footer class="modal-card-foot">
</footer>
</div>
</div>
</div>
</body>
</html>
